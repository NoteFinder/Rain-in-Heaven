<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Rain In Heaven</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-section { background: white; padding: 30px; border-radius: 20px; margin-bottom: 40px; border: 1px solid var(--card-border); }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .admin-table th, .admin-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 0.9rem; }
        .btn-download { background: #2ecc71; color: white; border: none; padding: 12px 25px; border-radius: 30px; cursor: pointer; margin-bottom: 15px; font-weight: bold; font-family: var(--font-body); text-transform: uppercase; font-size: 0.8rem; }
        .btn-delete { background: #ff4d4d; color: white; border: none; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 0.7rem; }
        input::placeholder { color: #ccc; }
    </style>
</head>
<body style="display: none;" id="adminBody"> <div class="container" style="margin-top: 50px;">
        <h1 class="maker-name" style="font-size: 2.5rem; text-align: center; color: var(--primary);">Management Dashboard</h1>

        <div class="admin-section">
            <h2 class="section-title" style="color: var(--primary); font-family: var(--font-heading);">Add New Theme</h2>
            <form id="themeForm" style="display: grid; gap: 15px; margin-top: 20px;">
                <input type="text" id="name" placeholder="Theme Name" class="sub-input" required>
                <input type="text" id="desc" placeholder="Short Description" class="sub-input" required>
                <input type="text" id="img" placeholder="Filename in img/ folder (e.g. sunset.jpg)" class="sub-input" required>
                <input type="url" id="try" placeholder="Galaxy Store 'Try' Link" class="sub-input" required>
                <input type="url" id="buy" placeholder="Galaxy Store 'Buy' Link" class="sub-input" required>
                <button type="submit" class="btn-subscribe" style="background: var(--primary);">Add to Gallery</button>
            </form>
        </div>

        <div class="admin-section">
            <h2 class="section-title" style="color: var(--primary); font-family: var(--font-heading); margin-bottom: 15px;">Newsletter Subscribers</h2>
            <button onclick="downloadCSV()" class="btn-download">Download CSV for Excel</button>
            <div style="overflow-x: auto;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Email Address</th>
                            <th>Country</th>
                            <th>Date Joined</th>
                        </tr>
                    </thead>
                    <tbody id="sub-list">
                        <tr><td colspan="3">Fetching subscribers...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 1. PASSWORD PROTECTION
        const AUTH_PASS = "021603"; // Change this to Greta's preferred password
        const entry = prompt("Please enter the administrator password:");

        if (entry === AUTH_PASS) {
            document.getElementById('adminBody').style.display = 'block';
            loadData();
        } else {
            alert("Unauthorized access.");
            window.location.href = "/"; // Redirect to home
        }

        // 2. LOAD SUBSCRIBERS FROM D1
        async function loadData() {
            try {
                const res = await fetch('/api/subscribers');
                const subs = await res.json();
                const list = document.getElementById('sub-list');
                
                if (subs.length === 0) {
                    list.innerHTML = '<tr><td colspan="3">No subscribers yet.</td></tr>';
                    return;
                }

                list.innerHTML = subs.map(s => `
                    <tr>
                        <td><strong>${s.email}</strong></td>
                        <td>${s.country || 'Global'}</td>
                        <td>${new Date(s.created_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');
                window.currentSubs = subs;
            } catch (err) {
                console.error("Failed to load subscribers:", err);
            }
        }

        // 3. THEME UPLOAD HANDLER
        document.getElementById('themeForm').onsubmit = async (e) => {
            e.preventDefault();
            const theme = {
                name: document.getElementById('name').value,
                description: document.getElementById('desc').value,
                image: document.getElementById('img').value,
                try_link: document.getElementById('try').value,
                link: document.getElementById('buy').value
            };
            
            const res = await fetch('/api/themes', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(theme) 
            });

            if (res.ok) { 
                alert("New theme successfully added!"); 
                location.reload(); 
            }
        };

        // 4. CSV EXPORT FOR NEWSLETTERS
        function downloadCSV() {
            if (!window.currentSubs || window.currentSubs.length === 0) {
                alert("No data to export.");
                return;
            }
            let csv = "Email,Country,Date Joined\n";
            window.currentSubs.forEach(s => {
                csv += `${s.email},${s.country},${s.created_at}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Rain_In_Heaven_Subscribers_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
